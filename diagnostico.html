<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico Completo - Supabase</title>
    <style>
        body {
            font-family: monospace;
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            line-height: 1.6;
        }
        .box {
            background: #2a2a2a;
            border: 2px solid #00ff00;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .success { color: #00ff00; }
        .error { color: #ff0000; }
        .warning { color: #ffaa00; }
        .info { color: #00aaff; }
        h2 { color: #00ffff; }
        pre {
            background: #000;
            padding: 10px;
            overflow-x: auto;
            border-radius: 4px;
        }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            font-family: monospace;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
            border-radius: 4px;
        }
        button:hover {
            background: #00cc00;
        }
    </style>
</head>
<body>
    <h1>üîç DIAGN√ìSTICO COMPLETO DO SUPABASE</h1>
    
    <div class="box">
        <h2>1Ô∏è‚É£ Carregamento do SDK</h2>
        <div id="sdk-check">Verificando...</div>
    </div>

    <div class="box">
        <h2>2Ô∏è‚É£ Arquivo config.js</h2>
        <div id="config-check">Verificando...</div>
    </div>

    <div class="box">
        <h2>3Ô∏è‚É£ Inicializa√ß√£o do Cliente</h2>
        <div id="client-check">Verificando...</div>
    </div>

    <div class="box">
        <h2>4Ô∏è‚É£ Teste de Conex√£o</h2>
        <div id="connection-check">Verificando...</div>
        <button onclick="testarConexao()">Testar Novamente</button>
    </div>

    <div class="box">
        <h2>5Ô∏è‚É£ Teste de Queries</h2>
        <div id="query-check">Aguardando...</div>
        <button onclick="testarQuery()">Testar Query</button>
    </div>

    <div class="box">
        <h2>üìã Informa√ß√µes do Sistema</h2>
        <div id="system-info">Coletando...</div>
    </div>

    <div class="box">
        <h2>üîß SOLU√á√ÉO RECOMENDADA</h2>
        <div id="solution">Aguarde o diagn√≥stico...</div>
    </div>

    <!-- Carregar Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        let testResults = {
            sdkLoaded: false,
            configLoaded: false,
            clientInitialized: false,
            connectionWorks: false,
            queryWorks: false
        };

        // Esperar um pouco para garantir que tudo carregou
        setTimeout(runDiagnostics, 1000);

        function log(elementId, message, type = 'info') {
            const el = document.getElementById(elementId);
            const color = {
                'success': 'success',
                'error': 'error', 
                'warning': 'warning',
                'info': 'info'
            }[type];
            el.innerHTML += `<div class="${color}">‚îî‚îÄ ${message}</div>`;
        }

        function clear(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        async function runDiagnostics() {
            console.log('üîç Iniciando diagn√≥stico completo...');
            
            // 1. Verificar SDK
            clear('sdk-check');
            if (typeof window.supabase !== 'undefined') {
                log('sdk-check', '‚úÖ Supabase SDK carregado corretamente', 'success');
                log('sdk-check', `Vers√£o detectada: ${window.supabase.createClient ? 'v2+' : 'desconhecida'}`, 'info');
                testResults.sdkLoaded = true;
            } else {
                log('sdk-check', '‚ùå Supabase SDK N√ÉO foi carregado', 'error');
                log('sdk-check', 'Poss√≠vel problema de conex√£o com CDN', 'warning');
                testResults.sdkLoaded = false;
            }

            // 2. Verificar config.js
            clear('config-check');
            try {
                // Tentar carregar as vari√°veis
                const scriptConfig = document.createElement('script');
                scriptConfig.src = 'config.js';
                document.head.appendChild(scriptConfig);
                
                await new Promise(resolve => setTimeout(resolve, 500));
                
                if (typeof SUPABASE_URL !== 'undefined' && typeof SUPABASE_ANON_KEY !== 'undefined') {
                    log('config-check', '‚úÖ Vari√°veis do config.js encontradas', 'success');
                    log('config-check', `URL: ${SUPABASE_URL}`, 'info');
                    log('config-check', `KEY: ${SUPABASE_ANON_KEY.substring(0, 30)}...`, 'info');
                    testResults.configLoaded = true;
                } else {
                    log('config-check', '‚ùå Vari√°veis do config.js N√ÉO encontradas', 'error');
                    testResults.configLoaded = false;
                }
            } catch (e) {
                log('config-check', `‚ùå Erro ao carregar config.js: ${e.message}`, 'error');
                testResults.configLoaded = false;
            }

            // 3. Verificar inicializa√ß√£o do cliente
            clear('client-check');
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            if (typeof supabase !== 'undefined' && supabase !== null) {
                log('client-check', '‚úÖ Cliente Supabase existe', 'success');
                
                // Verificar propriedades do cliente
                if (supabase.auth) {
                    log('client-check', '‚úÖ supabase.auth existe', 'success');
                } else {
                    log('client-check', '‚ùå supabase.auth √© undefined', 'error');
                }
                
                if (supabase.from) {
                    log('client-check', '‚úÖ supabase.from existe', 'success');
                } else {
                    log('client-check', '‚ùå supabase.from √© undefined', 'error');
                }
                
                log('client-check', `Tipo de supabase: ${typeof supabase}`, 'info');
                log('client-check', `Propriedades: ${Object.keys(supabase).join(', ')}`, 'info');
                
                testResults.clientInitialized = !!(supabase.auth && supabase.from);
            } else {
                log('client-check', '‚ùå Cliente Supabase N√ÉO foi inicializado', 'error');
                log('client-check', `typeof supabase = ${typeof supabase}`, 'info');
                testResults.clientInitialized = false;
            }

            // 4. Testar conex√£o
            await testarConexao();

            // 5. Informa√ß√µes do sistema
            mostrarInfoSistema();

            // 6. Gerar solu√ß√£o
            gerarSolucao();
        }

        async function testarConexao() {
            clear('connection-check');
            
            if (!testResults.clientInitialized) {
                log('connection-check', '‚ö†Ô∏è N√£o √© poss√≠vel testar - cliente n√£o inicializado', 'warning');
                return;
            }

            try {
                log('connection-check', 'üîÑ Testando getSession()...', 'info');
                const { data, error } = await supabase.auth.getSession();
                
                if (!error) {
                    log('connection-check', '‚úÖ getSession() funciona!', 'success');
                    log('connection-check', `Session: ${data.session ? 'Existe' : 'Null'}`, 'info');
                    testResults.connectionWorks = true;
                } else {
                    log('connection-check', `‚ùå Erro no getSession(): ${error.message}`, 'error');
                    testResults.connectionWorks = false;
                }
            } catch (e) {
                log('connection-check', `‚ùå Exce√ß√£o ao testar conex√£o: ${e.message}`, 'error');
                log('connection-check', `Stack: ${e.stack}`, 'error');
                testResults.connectionWorks = false;
            }
        }

        async function testarQuery() {
            clear('query-check');
            
            if (!testResults.clientInitialized) {
                log('query-check', '‚ö†Ô∏è N√£o √© poss√≠vel testar - cliente n√£o inicializado', 'warning');
                return;
            }

            try {
                log('query-check', 'üîÑ Testando query na tabela usuarios...', 'info');
                const { data, error } = await supabase
                    .from('usuarios')
                    .select('count');
                
                if (!error) {
                    log('query-check', '‚úÖ Query funcionou!', 'success');
                    log('query-check', `Resultado: ${JSON.stringify(data)}`, 'info');
                    testResults.queryWorks = true;
                } else {
                    log('query-check', `‚ùå Erro na query: ${error.message}`, 'error');
                    log('query-check', `Detalhes: ${JSON.stringify(error)}`, 'error');
                    testResults.queryWorks = false;
                }
            } catch (e) {
                log('query-check', `‚ùå Exce√ß√£o ao testar query: ${e.message}`, 'error');
                log('query-check', `Stack: ${e.stack}`, 'error');
                testResults.queryWorks = false;
            }
        }

        function mostrarInfoSistema() {
            const info = document.getElementById('system-info');
            info.innerHTML = `
                <div class="info">Navegador: ${navigator.userAgent}</div>
                <div class="info">URL Atual: ${window.location.href}</div>
                <div class="info">Protocolo: ${window.location.protocol}</div>
                <div class="info">Data/Hora: ${new Date().toLocaleString()}</div>
                <div class="info">Scripts Carregados: ${document.scripts.length}</div>
            `;
        }

        function gerarSolucao() {
            const solution = document.getElementById('solution');
            let html = '';

            if (!testResults.sdkLoaded) {
                html += `
                    <div class="error">‚ùå PROBLEMA: SDK do Supabase n√£o carregou</div>
                    <div class="warning">SOLU√á√ÉO:</div>
                    <div>1. Verifique sua conex√£o com internet</div>
                    <div>2. Tente acessar: https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2</div>
                    <div>3. Se n√£o funcionar, seu provedor pode estar bloqueando o CDN</div>
                `;
            } else if (!testResults.configLoaded) {
                html += `
                    <div class="error">‚ùå PROBLEMA: config.js n√£o carregou ou vari√°veis n√£o definidas</div>
                    <div class="warning">SOLU√á√ÉO:</div>
                    <div>1. Verifique se o arquivo config.js existe no reposit√≥rio</div>
                    <div>2. Abra o arquivo e verifique se tem as linhas:</div>
                    <pre>const SUPABASE_URL = 'sua-url';
const SUPABASE_ANON_KEY = 'sua-key';</pre>
                    <div>3. Commit e aguarde 2 minutos</div>
                `;
            } else if (!testResults.clientInitialized) {
                html += `
                    <div class="error">‚ùå PROBLEMA: Cliente Supabase n√£o foi inicializado corretamente</div>
                    <div class="warning">SOLU√á√ÉO:</div>
                    <div>1. O config.js deve ter esta linha EXATA:</div>
                    <pre>const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);</pre>
                    <div>2. Verifique se n√£o tem erros no JavaScript (F12 ‚Üí Console)</div>
                    <div>3. Substitua o config.js pelo config-limpo.js</div>
                `;
            } else if (!testResults.connectionWorks) {
                html += `
                    <div class="error">‚ùå PROBLEMA: Cliente inicializado mas getSession() falhou</div>
                    <div class="warning">SOLU√á√ÉO:</div>
                    <div>1. Verifique se a URL do Supabase est√° correta</div>
                    <div>2. Verifique se a KEY est√° correta</div>
                    <div>3. Acesse o Supabase Dashboard e verifique se o projeto est√° ativo</div>
                    <div>4. Teste acessar diretamente: ${typeof SUPABASE_URL !== 'undefined' ? SUPABASE_URL : 'sua-url'}</div>
                `;
            } else {
                html += `
                    <div class="success">‚úÖ TUDO FUNCIONANDO!</div>
                    <div class="info">O Supabase est√° configurado corretamente.</div>
                    <div class="info">Voc√™ pode usar o sistema normalmente.</div>
                    <div><a href="index.html" style="color: #00ff00;">‚Üê Voltar para o sistema</a></div>
                `;
            }

            solution.innerHTML = html;
        }
    </script>
</body>
</html>
